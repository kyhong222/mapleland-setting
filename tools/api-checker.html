<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Response Checker</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    h1 { margin-bottom: 20px; color: #333; }

    .category-tabs {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tab-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tab-group-label {
      width: 100%;
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }

    .tab-btn {
      padding: 6px 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      position: relative;
    }

    .tab-btn:hover { background: #e3f2fd; border-color: #1976d2; }
    .tab-btn.active { background: #1976d2; color: white; border-color: #1976d2; }
    .tab-btn.checked { border-color: #4caf50; }
    .tab-btn.has-errors { border-color: #f44336; }

    .tab-btn .badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #f44336;
      color: white;
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-primary { background: #1976d2; color: white; }
    .btn-primary:hover { background: #1565c0; }
    .btn-danger { background: #d32f2f; color: white; }
    .btn-danger:hover { background: #c62828; }
    .btn-success { background: #388e3c; color: white; }
    .btn-success:hover { background: #2e7d32; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }

    .progress-bar {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
    }

    .progress-bar.visible { display: block; }

    .progress-track {
      width: 100%;
      height: 24px;
      background: #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: #1976d2;
      border-radius: 12px;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
      min-width: 40px;
    }

    .stats-bar {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    .stats-bar span { color: #666; }
    .stats-bar strong { color: #333; }
    .stats-bar .fail { color: #d32f2f; }
    .stats-bar .success { color: #388e3c; }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    .result-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 12px;
      align-items: center;
      border-left: 4px solid #4caf50;
    }

    .result-card.fail {
      border-left-color: #f44336;
      background: #fff8f8;
    }

    .result-card.no-stats {
      border-left-color: #ff9800;
      background: #fff8e1;
    }

    .result-icon {
      width: 40px;
      height: 40px;
      background: #f5f5f5;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
    }

    .result-icon img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .result-info { flex: 1; min-width: 0; }

    .result-name {
      font-weight: bold;
      font-size: 13px;
      color: #333;
      word-break: break-word;
    }

    .result-meta {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .result-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      white-space: nowrap;
    }

    .result-status.ok { background: #e8f5e9; color: #2e7d32; }
    .result-status.error { background: #ffebee; color: #c62828; }
    .result-status.warn { background: #fff3e0; color: #e65100; }

    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }

    .filter-tab {
      padding: 6px 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 13px;
    }

    .filter-tab:hover { background: #f5f5f5; }
    .filter-tab.active { background: #1976d2; color: white; border-color: #1976d2; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      grid-column: 1 / -1;
    }

    .export-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
    }

    .export-section.visible { display: block; }

    .export-section textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>API Response Checker</h1>
    <p style="margin-bottom:15px; color:#666;">PreItem 목록의 각 아이템에 대해 maplestory.io API 응답을 확인합니다. 실패한 아이템은 PostItem으로 수동 등록이 필요합니다.</p>

    <div class="category-tabs">
      <div class="tab-group">
        <div class="tab-group-label">방어구</div>
        <button class="tab-btn" data-category="hat">투구</button>
        <button class="tab-btn" data-category="top">상의</button>
        <button class="tab-btn" data-category="bottom">하의</button>
        <button class="tab-btn" data-category="overall">전신</button>
        <button class="tab-btn" data-category="glove">장갑</button>
        <button class="tab-btn" data-category="shoes">신발</button>
        <button class="tab-btn" data-category="cape">망토</button>
        <button class="tab-btn" data-category="shield">방패</button>
      </div>
      <div class="tab-group">
        <div class="tab-group-label">장신구</div>
        <button class="tab-btn" data-category="earrings">귀고리</button>
        <button class="tab-btn" data-category="pendant">목걸이</button>
        <button class="tab-btn" data-category="faceAccessory">얼굴장식</button>
        <button class="tab-btn" data-category="eyeDecoration">눈장식</button>
      </div>
      <div class="tab-group">
        <div class="tab-group-label">무기</div>
        <button class="tab-btn" data-category="weapons/oneHandedSword">한손검</button>
        <button class="tab-btn" data-category="weapons/twoHandedSword">두손검</button>
        <button class="tab-btn" data-category="weapons/oneHandedAxe">한손도끼</button>
        <button class="tab-btn" data-category="weapons/twoHandedAxe">두손도끼</button>
        <button class="tab-btn" data-category="weapons/oneHandedBlunt">한손둔기</button>
        <button class="tab-btn" data-category="weapons/twoHandedBlunt">두손둔기</button>
        <button class="tab-btn" data-category="weapons/spear">창</button>
        <button class="tab-btn" data-category="weapons/polearm">폴암</button>
        <button class="tab-btn" data-category="weapons/bow">활</button>
        <button class="tab-btn" data-category="weapons/crossbow">석궁</button>
        <button class="tab-btn" data-category="weapons/staff">스태프</button>
        <button class="tab-btn" data-category="weapons/wand">완드</button>
        <button class="tab-btn" data-category="weapons/dagger">단검</button>
        <button class="tab-btn" data-category="weapons/claw">아대</button>
      </div>
      <div class="tab-group">
        <div class="tab-group-label">투사체</div>
        <button class="tab-btn" data-category="projectiles/arrowAmmo">화살</button>
        <button class="tab-btn" data-category="projectiles/crossbowBoltAmmo">석궁화살</button>
        <button class="tab-btn" data-category="projectiles/thrownAmmo">표창</button>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="startBtn" disabled>선택한 카테고리 검사</button>
      <button class="btn btn-danger" id="stopBtn" disabled>중지</button>
      <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
        <span>동시 요청:</span>
        <select id="concurrency" style="padding:4px 8px; border:1px solid #ddd; border-radius:4px;">
          <option value="3">3</option>
          <option value="5" selected>5</option>
          <option value="10">10</option>
          <option value="20">20</option>
        </select>
      </label>
      <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
        <span>요청 간격(ms):</span>
        <input type="number" id="delay" value="200" min="0" max="2000" step="50" style="width:70px; padding:4px 8px; border:1px solid #ddd; border-radius:4px;">
      </label>
    </div>

    <div class="progress-bar" id="progressBar">
      <span id="progressText">진행 중...</span>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
      </div>
    </div>

    <div class="stats-bar" id="statsBar" style="display:none;">
      <span>전체: <strong id="totalCount">0</strong></span>
      <span>성공: <strong id="successCount" class="success">0</strong></span>
      <span>스탯없음: <strong id="noStatsCount" style="color:#e65100;">0</strong></span>
      <span>실패: <strong id="failCount" class="fail">0</strong></span>
    </div>

    <div class="filter-tabs" id="filterTabs" style="display:none;">
      <button class="filter-tab active" data-filter="all">전체</button>
      <button class="filter-tab" data-filter="fail">실패 (API 에러)</button>
      <button class="filter-tab" data-filter="no-stats">스탯없음</button>
      <button class="filter-tab" data-filter="success">성공</button>
    </div>

    <div class="export-section" id="exportSection">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>실패 아이템 PostItem 템플릿</strong>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-success" id="copyBtn">복사</button>
          <button class="btn btn-primary" id="downloadTemplateBtn">다운로드</button>
        </div>
      </div>
      <textarea id="exportText" readonly></textarea>
    </div>

    <div class="result-grid" id="resultGrid">
      <div class="empty-state">카테고리를 선택하고 검사를 시작하세요</div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://maplestory.io/api/gms/62/item';

    let allResults = [];
    let currentFilter = 'all';
    let isRunning = false;
    let shouldStop = false;
    let currentCategory = '';

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressFill = document.getElementById('progressFill');
    const statsBar = document.getElementById('statsBar');
    const filterTabs = document.getElementById('filterTabs');
    const resultGrid = document.getElementById('resultGrid');
    const exportSection = document.getElementById('exportSection');
    const exportText = document.getElementById('exportText');

    // Category tab click
    document.querySelectorAll('.tab-btn[data-category]').forEach(btn => {
      btn.addEventListener('click', () => {
        if (isRunning) return;
        document.querySelectorAll('.tab-btn[data-category]').forEach(b => {
          if (!b.classList.contains('checked') && !b.classList.contains('has-errors')) {
            b.classList.remove('active');
          }
          b.classList.toggle('active', b.dataset.category === btn.dataset.category);
        });
        currentCategory = btn.dataset.category;
        startBtn.disabled = false;
      });
    });

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderResults();
      });
    });

    // Start check
    startBtn.addEventListener('click', async () => {
      if (!currentCategory || isRunning) return;
      await runCheck(currentCategory);
    });

    // Stop
    stopBtn.addEventListener('click', () => { shouldStop = true; });

    // Copy
    document.getElementById('copyBtn').addEventListener('click', () => {
      exportText.select();
      document.execCommand('copy');
      alert('복사되었습니다');
    });

    // Download template
    document.getElementById('downloadTemplateBtn').addEventListener('click', () => {
      const json = exportText.value;
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const fileName = currentCategory.split('/').pop() + '.json';
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    async function runCheck(category) {
      isRunning = true;
      shouldStop = false;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      allResults = [];

      progressBar.classList.add('visible');
      statsBar.style.display = 'flex';
      filterTabs.style.display = 'flex';
      exportSection.classList.remove('visible');
      resultGrid.innerHTML = '';

      // Load PreItem data
      let items;
      try {
        const response = await fetch(`../src/data/items/${category}.json`);
        items = await response.json();
      } catch (err) {
        alert(`파일을 불러올 수 없습니다: ${category}.json`);
        isRunning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        return;
      }

      const total = items.length;
      const concurrency = parseInt(document.getElementById('concurrency').value);
      const delay = parseInt(document.getElementById('delay').value);
      let completed = 0;
      let successCount = 0;
      let failCount = 0;
      let noStatsCount = 0;

      function updateProgress() {
        const pct = Math.round((completed / total) * 100);
        progressFill.style.width = pct + '%';
        progressFill.textContent = pct + '%';
        progressText.textContent = `${completed} / ${total} 검사 완료 (성공: ${successCount}, 스탯없음: ${noStatsCount}, 실패: ${failCount})`;
        document.getElementById('totalCount').textContent = total;
        document.getElementById('successCount').textContent = successCount;
        document.getElementById('noStatsCount').textContent = noStatsCount;
        document.getElementById('failCount').textContent = failCount;
      }

      async function checkItem(item) {
        if (shouldStop) return;

        const result = {
          id: item.id,
          name: item.name,
          koreanName: item.koreanName,
          reqJob: item.reqJob,
          reqLevel: item.reqLevel,
          status: 'success',
          error: null,
          metaInfo: null,
        };

        try {
          const response = await fetch(`${API_BASE}/${item.id}`);
          if (!response.ok) {
            result.status = 'fail';
            result.error = `HTTP ${response.status}`;
          } else {
            const data = await response.json();
            const meta = data?.metaInfo;
            if (!meta) {
              result.status = 'no-stats';
              result.error = 'metaInfo 없음';
            } else {
              // Check if there are any actual stats
              const hasStats = meta.incPAD || meta.incMAD || meta.incSTR || meta.incDEX ||
                               meta.incINT || meta.incLUK || meta.incPDD || meta.incMDD ||
                               meta.incACC || meta.incEVA;
              if (!hasStats && item.reqLevel > 0) {
                result.status = 'no-stats';
                result.error = '스탯 값 없음';
              }
              result.metaInfo = meta;
            }
          }
        } catch (err) {
          result.status = 'fail';
          result.error = err.message;
        }

        completed++;
        if (result.status === 'success') successCount++;
        else if (result.status === 'fail') failCount++;
        else if (result.status === 'no-stats') noStatsCount++;

        allResults.push(result);
        updateProgress();
      }

      // Run with concurrency limit
      updateProgress();

      for (let i = 0; i < total; i += concurrency) {
        if (shouldStop) break;
        const batch = items.slice(i, i + concurrency);
        await Promise.all(batch.map(checkItem));
        if (delay > 0 && i + concurrency < total) {
          await new Promise(r => setTimeout(r, delay));
        }
      }

      // Done
      isRunning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;

      // Sort results: fail first, then no-stats, then success
      allResults.sort((a, b) => {
        const order = { fail: 0, 'no-stats': 1, success: 2 };
        if (order[a.status] !== order[b.status]) return order[a.status] - order[b.status];
        return a.reqLevel - b.reqLevel;
      });

      // Update tab badge
      const tabBtn = document.querySelector(`.tab-btn[data-category="${category}"]`);
      if (tabBtn) {
        const errCount = failCount + noStatsCount;
        tabBtn.classList.add(errCount > 0 ? 'has-errors' : 'checked');
        if (errCount > 0) {
          let badge = tabBtn.querySelector('.badge');
          if (!badge) {
            badge = document.createElement('span');
            badge.className = 'badge';
            tabBtn.appendChild(badge);
          }
          badge.textContent = errCount;
        }
      }

      renderResults();
      generateExport();

      if (shouldStop) {
        progressText.textContent += ' (중지됨)';
      }
    }

    function renderResults() {
      const filtered = currentFilter === 'all'
        ? allResults
        : allResults.filter(r => r.status === currentFilter);

      if (filtered.length === 0) {
        resultGrid.innerHTML = '<div class="empty-state">표시할 결과가 없습니다</div>';
        return;
      }

      resultGrid.innerHTML = filtered.map(r => {
        const displayName = r.koreanName || r.name;
        const statusClass = r.status === 'fail' ? 'error' : r.status === 'no-stats' ? 'warn' : 'ok';
        const statusText = r.status === 'fail' ? '실패' : r.status === 'no-stats' ? '스탯없음' : '정상';
        const cardClass = r.status === 'fail' ? 'fail' : r.status === 'no-stats' ? 'no-stats' : '';

        return `
          <div class="result-card ${cardClass}">
            <div class="result-icon">
              <img src="${API_BASE}/${r.id}/icon" alt="" onerror="this.parentElement.innerHTML='?'">
            </div>
            <div class="result-info">
              <div class="result-name">${displayName}</div>
              <div class="result-meta">ID: ${r.id} | Lv.${r.reqLevel}${r.error ? ' | ' + r.error : ''}</div>
            </div>
            <span class="result-status ${statusClass}">${statusText}</span>
          </div>
        `;
      }).join('');
    }

    function generateExport() {
      const failedItems = allResults.filter(r => r.status === 'fail' || r.status === 'no-stats');
      if (failedItems.length === 0) {
        exportSection.classList.remove('visible');
        return;
      }

      exportSection.classList.add('visible');
      const isWeapon = currentCategory.startsWith('weapons/');

      // Generate PostItem template
      const postItems = {};
      failedItems.forEach(r => {
        if (r.metaInfo) {
          const meta = r.metaInfo;
          const stats = {
            attack: meta.incPAD || 0,
            str: meta.incSTR || 0,
            dex: meta.incDEX || 0,
            int: meta.incINT || 0,
            luk: meta.incLUK || 0,
            mad: meta.incMAD || 0,
            pdef: meta.incPDD || 0,
            mdef: meta.incMDD || 0,
            acc: meta.incACC || 0,
            eva: meta.incEVA || 0,
          };
          if (isWeapon) {
            stats.attackSpeed = meta.attackSpeed || 0;
          }
          postItems[r.id] = {
            koreanName: r.koreanName || r.name,
            stats,
            requireStats: {
              level: meta.reqLevel || r.reqLevel || 0,
              str: meta.reqSTR || 0,
              dex: meta.reqDEX || 0,
              int: meta.reqINT || 0,
              luk: meta.reqLUK || 0,
            }
          };
        } else {
          // API 완전 실패 - 빈 템플릿
          const stats = {
            attack: 0, str: 0, dex: 0, int: 0, luk: 0,
            mad: 0, pdef: 0, mdef: 0, acc: 0, eva: 0,
          };
          if (isWeapon) {
            stats.attackSpeed = 0;
          }
          postItems[r.id] = {
            koreanName: r.koreanName || r.name,
            stats,
            requireStats: {
              level: r.reqLevel || 0,
              str: 0, dex: 0, int: 0, luk: 0,
            }
          };
        }
      });

      exportText.value = JSON.stringify(postItems, null, 2);
    }
  </script>
</body>
</html>
